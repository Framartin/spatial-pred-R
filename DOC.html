<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>Extending Predictions from Spatial Econometric Models on R</title>
<!-- 2014-04-09 mer. 19:05 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
<meta name="generator" content="Org-mode"/>
<meta name="author" content="Jean-Sauveur AY \\ \lt[[mailto:jsay.site@gmail.com][jsay.site@gmail.com]]jsay.site@gmail.com\gt \and Julie LE GALLO\\ \lt[[mailto:jlegallo@univ-fcomte.fr][jlegallo@univ-fcomte.fr\gt]]jlegallo@univ-fcomte.fr\gt"/>
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center; }
  .todo   { font-family: monospace; color: red; }
  .done   { color: green; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  pre.src-sh:before    { content: 'sh'; }
  pre.src-bash:before  { content: 'sh'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-R:before     { content: 'R'; }
  pre.src-perl:before  { content: 'Perl'; }
  pre.src-java:before  { content: 'Java'; }
  pre.src-sql:before   { content: 'SQL'; }

  table { border-collapse:collapse; }
  td, th { vertical-align:top;  }
  th.right  { text-align: center;  }
  th.left   { text-align: center;   }
  th.center { text-align: center; }
  td.right  { text-align: right;  }
  td.left   { text-align: left;   }
  td.center { text-align: center; }
  dt { font-weight: bold; }
  .footpara:nth-child(2) { display: inline; }
  .footpara { display: block; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="http://thomasf.github.io/solarized-css/solarized-light.min.css" />

<script type="text/javascript" src="http://thomasf.github.io/solarized-css/org-info.min.js">
/**
 *
 * @source: http://thomasf.github.io/solarized-css/org-info.min.js
 *
 * @licstart  The following is the entire license notice for the
 *  JavaScript code in http://thomasf.github.io/solarized-css/org-info.min.js.
 *
 * Copyright (C) 2012-2013  Sebastian Rose
 *
 *
 * The JavaScript code in this tag is free software: you can
 * redistribute it and/or modify it under the terms of the GNU
 * General Public License (GNU GPL) as published by the Free Software
 * Foundation, either version 3 of the License, or (at your option)
 * any later version.  The code is distributed WITHOUT ANY WARRANTY;
 * without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.
 *
 * As additional permission under GNU GPL version 3 section 7, you
 * may distribute non-source (e.g., minimized or compacted) forms of
 * that code without the copy of the GNU GPL normally required by
 * section 4, provided you include this license notice and a URL
 * through which recipients can access the Corresponding Source.
 *
 * @licend  The above is the entire license notice
 * for the JavaScript code in http://thomasf.github.io/solarized-css/org-info.min.js.
 *
 */
</script>

<script type="text/javascript">

/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/

<!--/*--><![CDATA[/*><!--*/
org_html_manager.set("TOC_DEPTH", "5");
org_html_manager.set("LINK_HOME", "");
org_html_manager.set("LINK_UP", "");
org_html_manager.set("LOCAL_TOC", "1");
org_html_manager.set("VIEW_BUTTONS", "0");
org_html_manager.set("MOUSE_HINT", "underline");
org_html_manager.set("FIXED_TOC", "0");
org_html_manager.set("TOC", "1");
org_html_manager.set("VIEW", "1");
org_html_manager.setup();  // activate after the parameters are set
/*]]>*///-->
</script>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012  Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
<script type="text/javascript" src="http://orgmode.org/mathjax/MathJax.js">
<!--/*--><![CDATA[/*><!--*/
    MathJax.Hub.Config({
        // Only one of the two following lines, depending on user settings
        // First allows browser-native MathML display, second forces HTML/CSS
        //  config: ["MMLorHTML.js"], jax: ["input/TeX"],
            jax: ["input/TeX", "output/HTML-CSS"],
        extensions: ["tex2jax.js","TeX/AMSmath.js","TeX/AMSsymbols.js",
                     "TeX/noUndefined.js"],
        tex2jax: {
            inlineMath: [ ["\\(","\\)"] ],
            displayMath: [ ['$$','$$'], ["\\[","\\]"], ["\\begin{displaymath}","\\end{displaymath}"] ],
            skipTags: ["script","noscript","style","textarea","pre","code"],
            ignoreClass: "tex2jax_ignore",
            processEscapes: false,
            processEnvironments: true,
            preview: "TeX"
        },
        showProcessingMessages: true,
        displayAlign: "center",
        displayIndent: "2em",

        "HTML-CSS": {
             scale: 100,
             availableFonts: ["STIX","TeX"],
             preferredFont: "TeX",
             webFont: "TeX",
             imageFont: "TeX",
             showMathMenu: true,
        },
        MMLorHTML: {
             prefer: {
                 MSIE:    "MML",
                 Firefox: "MML",
                 Opera:   "HTML",
                 other:   "HTML"
             }
        }
    });
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">Extending Predictions from Spatial Econometric Models on R</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1. Major changes relative to <code>predict.sarlm</code></a>
<ul>
<li><a href="#sec-1-1">1.1. About the intercept</a></li>
</ul>
</li>
<li><a href="#sec-2">2. Statistical Framework</a>
<ul>
<li><a href="#sec-2-1">2.1. Spatial Econometric</a></li>
<li><a href="#sec-2-2">2.2. Making Predictions</a></li>
</ul>
</li>
<li><a href="#sec-3">3. Current function from <code>spdep</code></a></li>
<li><a href="#sec-4">4. The <code>sppred</code> extension</a>
<ul>
<li><a href="#sec-4-1">4.1. General Structure</a></li>
<li><a href="#sec-4-2">4.2. Predictors conditioned on X, W</a>
<ul>
<li><a href="#sec-4-2-1">4.2.1. without lagged endogenous</a></li>
<li><a href="#sec-4-2-2">4.2.2. With lagged endogenous</a></li>
</ul>
</li>
<li><a href="#sec-4-3">4.3. Predictors conditioned on X, W, e</a></li>
<li><a href="#sec-4-4">4.4. Predictors conditioned on X, W, y</a></li>
<li><a href="#sec-4-5">4.5. Predictors conditioned by hand</a></li>
</ul>
</li>
<li><a href="#sec-5">5. How it works</a>
<ul>
<li><a href="#sec-5-1">5.1. Choosing a type of predictor</a></li>
<li><a href="#sec-5-2">5.2. Specifying</a></li>
<li><a href="#sec-5-3">5.3. General structure, usual checks, and IS predictions</a></li>
<li><a href="#sec-5-4">5.4. The predictors 1 for OS predictions</a></li>
</ul>
</li>
<li><a href="#sec-6">6. Testing</a>
<ul>
<li><a href="#sec-6-1">6.1. Sample</a></li>
<li><a href="#sec-6-2">6.2. Estimating the spatial models</a></li>
<li><a href="#sec-6-3">6.3. Testing the predictors</a>
<ul>
<li><a href="#sec-6-3-1">6.3.1. Conditioned on X</a></li>
<li><a href="#sec-6-3-2">6.3.2. Conditioned on X, W</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div class="abstract">
<p>
This document presents a framework and some <code>R</code> code &#x2013;
&#x2013; to make predictions from spatial autoregressive
models. In particular, it implements the predictors from LeSage and
Pace (2004, 2008) and Kelejian and Prucha (2004) for a large number of
autoregressive models from the <code>spdep</code> package (Bivand 2014). The
status is actually under construction, comments are welcome.<br/>
</p>

<p>
<b>TODO</b>
</p>
<ul class="org-ul">
<li>Code the variances and confidence intervals of predictors
</li>
<li>Allow different weight matrix between lags and errors
</li>
<li>Code the predictors for objects form <code>sphet</code> and <code>splm</code>
</li>
</ul>

</div>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> Major changes relative to <code>predict.sarlm</code></h2>
<div class="outline-text-2" id="text-1">
<ul class="org-ul">
<li>Implement predictions for SARAR and Mixed SARAR models from
respectively <code>sac</code> and <code>sacmixed</code> classes.
</li>
<li>Compute BLUP and almost BLUP spatial predictors
</li>
<li>About the in-sample / out of sample structure (<code>newdata</code>)
</li>
<li>About the distinction between trend and signal
</li>
<li>The simplification of the in-sample predictions
</li>
</ul>
</div>

<div id="outline-container-sec-1-1" class="outline-3">
<h3 id="sec-1-1"><span class="section-number-3">1.1</span> About the intercept</h3>
<div class="outline-text-3" id="text-1-1">
<p>
We change the scan of the intercept, in particular in presence of
\(WX\) in the regression. If \(W\) is row standardized, we have to drop
the intercept to avoid collinearity. The initial function add the
constant at the end of the computations, we only drop the intercept
in the presence of \(WX\).
</p>
</div>
</div>
</div>
<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> Statistical Framework</h2>
<div class="outline-text-2" id="text-2">
</div><div id="outline-container-sec-2-1" class="outline-3">
<h3 id="sec-2-1"><span class="section-number-3">2.1</span> Spatial Econometric</h3>
<div class="outline-text-3" id="text-2-1">
<p>
From the more general from of the Cliff-Ord (1973, 1981)
homoscedastic class of models with exogenous covariates,<sup><a id="fnr.1" name="fnr.1" class="footref" href="#fn.1">1</a></sup>
</p>

\begin{align}
y           & = \rho Wy+X\beta+\gamma WX+ \varepsilon\nonumber\\
\varepsilon & = \lambda W\varepsilon+ u \nonumber
\end{align}

<p>
with \(u\sim \mathbf{N}(0, \sigma^2\cdot I_N)\). The \(y\) is a
\(N\times 1\) vector continuous outcome, \(X\) is a \(N\times K\) matrix
of the \(K\) covariates, and \(W\) is a \(N\times N\) spatial weight
matrix. We limit ourselves to a same weight matrix in the outcome
and error equations, but nothing precludes this restriction. The
unknown parameters \(\rho\), \(\gamma\), \(\lambda\) and \(\sigma\) have to
be estimated, as the vector \(u\) of residuals. Classically, we
assume that \(\mbox{diag}(W)= 0\), \(\mid \rho \mid< 1\), \(\mid \lambda
   \mid< 1\). <i>standardization of W?</i> Not the same notations than
KP 2007.
</p>

<p>
By construction, \(W_{ii}\) &gt; \(0\) to preclude an observation from
directly predicting itself
</p>

<p>
The geo-statistical models usually involve specifying spatial
dependence through the error process as opposed to the spatial lag
of the y vector, and these "error models" take a simpler form than
autoregressive models
</p>

<p>
This model is sufficiently general that the SARAR(1,1) model can be
recovered with \(\theta= 0\) (Kelejian2007) (also called SAC by
Biva02, BPGR13), the spatial error model (SEM) can be recovered
with \(\rho=\theta= 0\), the spatial X model (SXM) with \(\rho=0\), the
spatial autoregressive (SAR) model with \(\theta=\lambda=0\); and the
spatial Durbin model (SDM) model can be recovered when
\(\lambda=0\). Another useful non exclusive distinction is the error
models (SEM, SDM and SARAR) and the lag models (SAR, SDM and SARAR)
</p>
</div>
</div>
<div id="outline-container-sec-2-2" class="outline-3">
<h3 id="sec-2-2"><span class="section-number-3">2.2</span> Making Predictions</h3>
<div class="outline-text-3" id="text-2-2">
<p>
The bias of actual predictors come from the correlation between
the spatially lagged dependent variable and the error term.
</p>

<p>
Since \(W_{ii}=0\), \(W y\) does not use \(y_i\) to predict itself.
</p>

<p>
Can we still maintain the signal trend distinction? Does it the
same as direct and indirect effects of covariates?
</p>

<p>
We develop a framework of prediction from models with
interdependent observations.
</p>

<p>
We implement the KP1 predictors, also called exogenous by LeSage
and Pace.
</p>

<p>
We have to explain the differences between in-sample, out-of-sample
and ex-sample in a spatial context. Ex-sample is not necessary
linked to temporal, it is also interesting to counterfactual
simulations. The prediction in out-of-sample needs a certain
spatial embedding between the two spatial samples, not having
sampled neighbors does not mean no neighbors. But in a spatial
segregative case, this corresponds to a ex-sample case.
</p>
</div>
</div>
</div>
<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3"><span class="section-number-2">3</span> Current function from <code>spdep</code></h2>
<div class="outline-text-2" id="text-3">
<p>
Our code is an extension of the function <code>predict.sarlm()</code> actually
the default function from the package <code>spdep</code> (Bivand).
</p>

<div class="org-src-container">

<pre class="src src-R" id="Lst:DFT"><span style="color: #4c83ff;">library</span>(spdep) ; predict.sarlm
</pre>
</div>

<p>
<a href="predict-sarlm.R">predict-sarlm.R</a>
</p>

<p>
The current function, accessible through previous link, implement
different predictor according to the absence of the presence of
newdata. For the in-sample predictions (<code>if(newdata==</code> <code>NULL)</code>), the
predictors are computed as Eq. XX using BLUP. For the out of sample
predictions (<code>if(newdata!=</code> <code>NULL)</code>), the predictors are computed as
Eq. XX using biased and inefficient predictors. It produces
inconsistencies by not implementing the same predictions if we put
the data that are used to fit the model in the <code>newdata</code> argument
(cf. XX example below). Another shortcoming of the current function
is the class of objects from SEM and SXM: they are not
vectors. Lastly, if we put <code>sacmixed</code> objects in the current
function, they are not recognized as such and produce some errors
about matrix dimension.
</p>

<p>
At the center of this distinction is the observability of the
outcome variable \(y\).
</p>

<p>
Some other particularities are present in the current function. The
OS predictor for error models is KP1 but not directly for lag
models. For that, we have to put <code>legacy==</code> <code>FALSE</code>. The signal is
computed by difference for the lag models in out of sample.
</p>
</div>
</div>
<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4"><span class="section-number-2">4</span> The <code>sppred</code> extension</h2>
<div class="outline-text-2" id="text-4">
</div><div id="outline-container-sec-4-1" class="outline-3">
<h3 id="sec-4-1"><span class="section-number-3">4.1</span> General Structure</h3>
<div class="outline-text-3" id="text-4-1">
<p>
Here is the general structure of the functions that call
sub-functions that are defined below.
</p>

<p>
This function contents the usual verifications, with 2 more
arguments: <code>cond.set</code> for the conditional set (see XX) and <code>mean</code>
for the specification of the structural mean.
</p>

<p>
The scan for the lagged WX is by the presence of "lag." at their
name, it has to be changed.
</p>

<div class="org-src-container">

<pre class="src src-R"><span style="color: #ff1493;">sppred</span> <span style="color: #4c83ff;">&lt;-</span> <span style="color: #FBDE2D;">function</span>(object, newdata = <span style="color: #D8FA3C;">NULL</span>, listw = <span style="color: #D8FA3C;">NULL</span>,
                   zero.policy = <span style="color: #D8FA3C;">NULL</span>, condset = <span style="color: #61CE3C;">"X"</span>, avg = <span style="color: #61CE3C;">"DEF"</span>,
                   legacy= <span style="color: #D8FA3C;">TRUE</span>, power= <span style="color: #D8FA3C;">NULL</span>, order= 250,
                   tol= .Machine$double.eps^(3/5), ...) {
    <span style="color: #8B8989; font-style: italic;">## </span><span style="color: #8B8989; font-style: italic;">USUAL VERIFICATIONS</span>
    <span style="color: #FBDE2D;">if</span> (is.null(zero.policy)) 
        zero.policy <span style="color: #4c83ff;">&lt;-</span> get(<span style="color: #61CE3C;">"zeroPolicy"</span>, envir = spdep:::.spdepOptions)
    stopifnot(is.logical(zero.policy))
    <span style="color: #FBDE2D;">if</span> (is.null(power)) power <span style="color: #4c83ff;">&lt;-</span> object$method != <span style="color: #61CE3C;">"eigen"</span>
    stopifnot(is.logical(legacy)) ; stopifnot(is.logical(power))
    <span style="color: #8B8989; font-style: italic;">## </span><span style="color: #8B8989; font-style: italic;">DETERMINING THE MODEL</span>
    <span style="color: #FBDE2D;">if</span> (object$type== <span style="color: #61CE3C;">"error"</span>){
        mod <span style="color: #4c83ff;">&lt;-</span> ifelse(object$etype== <span style="color: #61CE3C;">"error"</span>, <span style="color: #61CE3C;">"sem"</span>, <span style="color: #61CE3C;">"sxm"</span>)
    } <span style="color: #FBDE2D;">else</span> {
        mod <span style="color: #4c83ff;">&lt;-</span> <span style="color: #FBDE2D;">switch</span>(object$type, <span style="color: #61CE3C;">"lag"</span>= <span style="color: #61CE3C;">"sar"</span>, <span style="color: #61CE3C;">"mixed"</span>= <span style="color: #61CE3C;">"sdm"</span>,
                                   <span style="color: #61CE3C;">"sac"</span>= <span style="color: #61CE3C;">"sac"</span>, <span style="color: #61CE3C;">"sacmixed"</span>= <span style="color: #61CE3C;">"smc"</span>)
    }
    <span style="color: #8B8989; font-style: italic;">## </span><span style="color: #8B8989; font-style: italic;">DATA SHAPING</span>
    Wlg <span style="color: #4c83ff;">&lt;-</span> substr(names(object$coefficients), 1, 4)== <span style="color: #61CE3C;">"lag."</span>
    B <span style="color: #4c83ff;">&lt;-</span> object$coefficients[ !Wlg]
    <span style="color: #FBDE2D;">if</span> (is.null(newdata)){
        nd  <span style="color: #4c83ff;">&lt;-</span> <span style="color: #D8FA3C;">FALSE</span>
        X   <span style="color: #4c83ff;">&lt;-</span> object$X[, !Wlg]
    } <span style="color: #FBDE2D;">else</span> {
        nd  <span style="color: #4c83ff;">&lt;-</span> <span style="color: #D8FA3C;">TRUE</span>
        frm <span style="color: #4c83ff;">&lt;-</span> formula(object$call)
        mt  <span style="color: #4c83ff;">&lt;-</span> delete.response(terms(frm, data = newdata))
        mf  <span style="color: #4c83ff;">&lt;-</span> model.frame(mt, newdata)
        X   <span style="color: #4c83ff;">&lt;-</span> model.matrix(mt, mf)
        <span style="color: #FBDE2D;">if</span> (any(object$aliased)) X <span style="color: #4c83ff;">&lt;-</span> X[, -which(object$aliased)]
    }
    <span style="color: #8B8989; font-style: italic;">## </span><span style="color: #8B8989; font-style: italic;">WEIGHT MATRIX</span>
    <span style="color: #FBDE2D;">if</span> (!nd) lsw <span style="color: #4c83ff;">&lt;-</span> eval(object$call$listw) <span style="color: #FBDE2D;">else</span> lsw <span style="color: #4c83ff;">&lt;-</span> listw
    <span style="color: #8B8989; font-style: italic;">## </span><span style="color: #8B8989; font-style: italic;">THE PREDICTORS</span>
    <span style="color: #FBDE2D;">if</span> (condset== <span style="color: #61CE3C;">"X"</span>) prd <span style="color: #4c83ff;">&lt;-</span> as.vector(X %*% B)
    <span style="color: #FBDE2D;">if</span> (condset== <span style="color: #61CE3C;">"XW"</span>)
        prd <span style="color: #4c83ff;">&lt;-</span> prd1(object, mod, nd, B, X, lsw)
    <span style="color: #FBDE2D;">if</span> (condset== <span style="color: #61CE3C;">"XW"</span> &amp;&amp; !mod %<span style="color: #FBDE2D;">in</span>% c(<span style="color: #61CE3C;">"sem"</span>, <span style="color: #61CE3C;">"sxm"</span>) &amp;&amp; avg == <span style="color: #61CE3C;">"INV"</span>)
        prd <span style="color: #4c83ff;">&lt;-</span> prd2(object, prd, mod, lsw, power, order, tol)
    <span style="color: #FBDE2D;">if</span> (condset== <span style="color: #61CE3C;">"XWe"</span>)
        prd <span style="color: #4c83ff;">&lt;-</span> prd3(object, B, X, listw, power, legacy, order, tol)
    <span style="color: #FBDE2D;">if</span> (condset== <span style="color: #61CE3C;">"XWy"</span>)
        prd <span style="color: #4c83ff;">&lt;-</span> prd4(object, B, X, listw, power, legacy, order, tol)
    <span style="color: #FBDE2D;">if</span> (condset== <span style="color: #61CE3C;">"XWc"</span>)
        prd <span style="color: #4c83ff;">&lt;-</span> prd5(object, B, X, listw, power, legacy, order, tol)
    class(prd) <span style="color: #4c83ff;">&lt;-</span> <span style="color: #61CE3C;">"sppred"</span>
    prd
}
</pre>
</div>

<p>
we choose to not use <code>object$tarX</code> and <code>object$tarY</code> for more
transparencies. It is clear that we lost from that in terms of
computation time. It is easy to predict by conditioning only on "X"
because it is the same form for all the spatial models (see
equation XX).
</p>
</div>
</div>
<div id="outline-container-sec-4-2" class="outline-3">
<h3 id="sec-4-2"><span class="section-number-3">4.2</span> Predictors conditioned on X, W</h3>
<div class="outline-text-3" id="text-4-2">
</div><div id="outline-container-sec-4-2-1" class="outline-4">
<h4 id="sec-4-2-1"><span class="section-number-4">4.2.1</span> without lagged endogenous</h4>
<div class="outline-text-4" id="text-4-2-1">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #ff1493;">prd1</span> <span style="color: #4c83ff;">&lt;-</span> <span style="color: #FBDE2D;">function</span>(object, mod= mod, nd= nd, B= B, X= X, lsw= lsw){
    <span style="color: #FBDE2D;">if</span> (mod!= <span style="color: #61CE3C;">"sem"</span> &amp;&amp; nd){
        <span style="color: #FBDE2D;">if</span> (is.null(lsw) || !inherits(lsw, <span style="color: #61CE3C;">"listw"</span>))
            <span style="color: #FBDE2D;">stop</span>(<span style="color: #61CE3C;">"spatial weights list required"</span>)
    }
    <span style="color: #FBDE2D;">if</span> (mod %<span style="color: #FBDE2D;">in</span>% c(<span style="color: #61CE3C;">"sxm"</span>, <span style="color: #61CE3C;">"sdm"</span>, <span style="color: #61CE3C;">"smc"</span>)){
        m <span style="color: #4c83ff;">&lt;-</span> ncol(X)
        K <span style="color: #4c83ff;">&lt;-</span> ifelse(colnames(object$X)[ 1] == <span style="color: #61CE3C;">"(Intercept)"</span>, 2, 1)
        WX <span style="color: #4c83ff;">&lt;-</span> matrix(nrow= nrow(X), ncol= m+ 1- K)
        <span style="color: #FBDE2D;">for</span> (k <span style="color: #FBDE2D;">in</span> K: m){
            wx <span style="color: #4c83ff;">&lt;-</span> lag.listw(lsw, X[, k])
            <span style="color: #FBDE2D;">if</span> (any(is.na(wx)))
                <span style="color: #FBDE2D;">stop</span>(<span style="color: #61CE3C;">"NAs in lagged independent variable"</span>)
            WX[, k+ 1- K] <span style="color: #4c83ff;">&lt;-</span> wx
        }
        prdWX <span style="color: #4c83ff;">&lt;-</span> cbind(X, WX) %*% object$coefficients
    } <span style="color: #FBDE2D;">else</span> {
        prdWX <span style="color: #4c83ff;">&lt;-</span> X %*% B
    }
    as.vector(prdWX)
}
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-4-2-2" class="outline-4">
<h4 id="sec-4-2-2"><span class="section-number-4">4.2.2</span> With lagged endogenous</h4>
<div class="outline-text-4" id="text-4-2-2">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #ff1493;">prd2</span> <span style="color: #4c83ff;">&lt;-</span> <span style="color: #FBDE2D;">function</span>(object, prd= prd, mod= mod, lsw= lsw,
                 power= power, order= order, tol= tol){
    <span style="color: #FBDE2D;">if</span> (power){
        W <span style="color: #4c83ff;">&lt;-</span> as(as_dgRMatrix_listw(lsw), <span style="color: #61CE3C;">"CsparseMatrix"</span>)
        prdWXi <span style="color: #4c83ff;">&lt;-</span> c(as(powerWeights(W, rho= object$rho, X= prd,
                                    order= order, tol= tol), <span style="color: #61CE3C;">"matrix"</span>))
    } <span style="color: #FBDE2D;">else</span> {
        prdWXi <span style="color: #4c83ff;">&lt;-</span> c(invIrW(lsw, object$rho) %*% prd)
    }
    as.vector(prdWXi)
}
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-sec-4-3" class="outline-3">
<h3 id="sec-4-3"><span class="section-number-3">4.3</span> Predictors conditioned on X, W, e</h3>
</div>
<div id="outline-container-sec-4-4" class="outline-3">
<h3 id="sec-4-4"><span class="section-number-3">4.4</span> Predictors conditioned on X, W, y</h3>
</div>
<div id="outline-container-sec-4-5" class="outline-3">
<h3 id="sec-4-5"><span class="section-number-3">4.5</span> Predictors conditioned by hand</h3>
</div>
</div>

<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5"><span class="section-number-2">5</span> How it works</h2>
<div class="outline-text-2" id="text-5">
</div><div id="outline-container-sec-5-1" class="outline-3">
<h3 id="sec-5-1"><span class="section-number-3">5.1</span> Choosing a type of predictor</h3>
<div class="outline-text-3" id="text-5-1">
<p>
Our new <code>R</code> function for spatial predictions &#x2013; called <code>sppred</code> for
the moment &#x2013; admits a first additional argument <code>predictor</code> that
specify the computed predictor. Knowing that predictors
corresponding to larger information sets are more complex,
flexibility is needed to let the user makes its own trade-off
between simplicity and prediction efficiency. The following table
define the available predictors.
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption>The available values for the new <code>predictor</code> argument</caption>

<colgroup>
<col class="left"/>

<col class="left"/>

<col class="left"/>
</colgroup>
<thead>
<tr>
<th scope="col" class="left"><code>predictor</code></th>
<th scope="col" class="left">label</th>
<th scope="col" class="left">equation (see XX)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">"1"</td>
<td class="left">minimum information</td>
<td class="left">(XX)</td>
</tr>

<tr>
<td class="left">"2"</td>
<td class="left">heuristic BLUP</td>
<td class="left">(XX)</td>
</tr>

<tr>
<td class="left">"3"</td>
<td class="left">BLUP</td>
<td class="left">(XX)</td>
</tr>

<tr>
<td class="left">"4"</td>
<td class="left">heuristic data</td>
<td class="left">(XX)</td>
</tr>
</tbody>
</table>

<p>
The <code>predictor</code> 4 is currently the default for IS prediction in
<code>predict.sarlm</code> (it corresponds to the predictor KP4 for lag models
and KP5 for error models).
</p>
</div>
</div>
<div id="outline-container-sec-5-2" class="outline-3">
<h3 id="sec-5-2"><span class="section-number-3">5.2</span> Specifying</h3>
</div>
<div id="outline-container-sec-5-3" class="outline-3">
<h3 id="sec-5-3"><span class="section-number-3">5.3</span> General structure, usual checks, and IS predictions</h3>
<div class="outline-text-3" id="text-5-3">
<p>
Here the code, for the inverse integrating directly the code from
powerWeigths?
</p>
</div>
</div>
<div id="outline-container-sec-5-4" class="outline-3">
<h3 id="sec-5-4"><span class="section-number-3">5.4</span> The predictors 1 for OS predictions</h3>
</div>
</div>

<div id="outline-container-sec-6" class="outline-2">
<h2 id="sec-6"><span class="section-number-2">6</span> Testing</h2>
<div class="outline-text-2" id="text-6">
</div><div id="outline-container-sec-6-1" class="outline-3">
<h3 id="sec-6-1"><span class="section-number-3">6.1</span> Sample</h3>
<div class="outline-text-3" id="text-6-1">
<div class="org-src-container">

<pre class="src src-R" id="Lst:PSS">load(<span style="color: #61CE3C;">"Data/exsmp.Rda"</span>) ; <span style="color: #4c83ff;">library</span>(spdep)
plot(exsmp$Dat.all)
plot(exsmp$Dat.cal, col= <span style="color: #61CE3C;">"blue"</span>, pch= 20, add= <span style="color: #D8FA3C;">TRUE</span>)
</pre>
</div>

<p>
<a href="Figures/PrsSpSmp.pdf">Figures/PrsSpSmp.pdf</a>
</p>
</div>
</div>
<div id="outline-container-sec-6-2" class="outline-3">
<h3 id="sec-6-2"><span class="section-number-3">6.2</span> Estimating the spatial models</h3>
<div class="outline-text-3" id="text-6-2">
<div class="org-src-container">

<pre class="src src-R">SEM <span style="color: #4c83ff;">&lt;-</span> errorsarlm(ARlog03~ PXLB03+ RTFO03+ BdAlti, data= exsmp$Dat.cal,
                  exsmp$Wgt.cal, method= <span style="color: #61CE3C;">"eigen"</span>)
SXM <span style="color: #4c83ff;">&lt;-</span> errorsarlm(ARlog03~ PXLB03+ RTFO03+ BdAlti, data= exsmp$Dat.cal,
                  exsmp$Wgt.cal, method= <span style="color: #61CE3C;">"eigen"</span>, etype= <span style="color: #61CE3C;">"emixed"</span>)
SAR <span style="color: #4c83ff;">&lt;-</span> lagsarlm(  ARlog03~ PXLB03+ RTFO03+ BdAlti, data= exsmp$Dat.cal,
                  exsmp$Wgt.cal, method= <span style="color: #61CE3C;">"eigen"</span>)
SDM <span style="color: #4c83ff;">&lt;-</span> lagsarlm(  ARlog03~ PXLB03+ RTFO03+ BdAlti, data= exsmp$Dat.cal,
                  exsmp$Wgt.cal, method= <span style="color: #61CE3C;">"eigen"</span>, type= <span style="color: #61CE3C;">"mixed"</span>)
SAC <span style="color: #4c83ff;">&lt;-</span> sacsarlm(  ARlog03~ PXLB03+ RTFO03+ BdAlti, data= exsmp$Dat.cal,
                  exsmp$Wgt.cal, method= <span style="color: #61CE3C;">"eigen"</span>)
SMC <span style="color: #4c83ff;">&lt;-</span> sacsarlm(  ARlog03~ PXLB03+ RTFO03+ BdAlti, data= exsmp$Dat.cal,
                  exsmp$Wgt.cal, method= <span style="color: #61CE3C;">"eigen"</span>, type= <span style="color: #61CE3C;">"sacmixed"</span>)
<span style="color: #4c83ff;">library</span>(plyr)
t(ldply(list(SEM, SXM, SAR, SDM, SAC, SMC), AIC))
</pre>
</div>

<pre class="example">
       [,1]     [,2]     [,3]     [,4]     [,5]    [,6]
V1 445.7127 433.3333 435.5886 434.1438 436.3016 435.197
</pre>
</div>
</div>
<div id="outline-container-sec-6-3" class="outline-3">
<h3 id="sec-6-3"><span class="section-number-3">6.3</span> Testing the predictors</h3>
<div class="outline-text-3" id="text-6-3">
</div><div id="outline-container-sec-6-3-1" class="outline-4">
<h4 id="sec-6-3-1"><span class="section-number-4">6.3.1</span> Conditioned on X</h4>
<div class="outline-text-4" id="text-6-3-1">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #4c83ff;">source</span>(<span style="color: #61CE3C;">"sppred.R"</span>)
SEMprdX <span style="color: #4c83ff;">&lt;-</span> sppred(SEM, newdata= exsmp$Dat.cal, listw= exsmp$Wgt.cal)
SXMprdX <span style="color: #4c83ff;">&lt;-</span> sppred(SXM)

SARprdX <span style="color: #4c83ff;">&lt;-</span> sppred(SAR)
SDMprdX <span style="color: #4c83ff;">&lt;-</span> sppred(SDM)
SACprdX <span style="color: #4c83ff;">&lt;-</span> sppred(SAC)
SMCprdX <span style="color: #4c83ff;">&lt;-</span> sppred(SMC)
sqrt(mean(I(SEMprdX- SAR$y)^2))
sqrt(mean(I(SXMprdX- SAR$y)^2))
sqrt(mean(I(SARprdX- SAR$y)^2))
sqrt(mean(I(SDMprdX- SAR$y)^2))
sqrt(mean(I(SACprdX- SAR$y)^2))
sqrt(mean(I(SMCprdX- SAR$y)^2))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-6-3-2" class="outline-4">
<h4 id="sec-6-3-2"><span class="section-number-4">6.3.2</span> Conditioned on X, W</h4>
<div class="outline-text-4" id="text-6-3-2">
<div class="org-src-container">

<pre class="src src-R"><span style="color: #4c83ff;">source</span>(<span style="color: #61CE3C;">"sppred.R"</span>)
SEMprdX <span style="color: #4c83ff;">&lt;-</span> sppred(SEM)
SXMprdX <span style="color: #4c83ff;">&lt;-</span> sppred(SXM)
SARprdX <span style="color: #4c83ff;">&lt;-</span> sppred(SAR)
SDMprdX <span style="color: #4c83ff;">&lt;-</span> sppred(SDM)
SACprdX <span style="color: #4c83ff;">&lt;-</span> sppred(SAC)
SMCprdX <span style="color: #4c83ff;">&lt;-</span> sppred(SMC)
SEMprdXW <span style="color: #4c83ff;">&lt;-</span> sppred(SEM, condset= <span style="color: #61CE3C;">"XW"</span>)
SXMprdXW <span style="color: #4c83ff;">&lt;-</span> sppred(SXM, condset= <span style="color: #61CE3C;">"XW"</span>)
SXMprdXWi <span style="color: #4c83ff;">&lt;-</span> sppred(SXM, condset= <span style="color: #61CE3C;">"XW"</span>, avg= <span style="color: #61CE3C;">"INV"</span>)
SARprdXW <span style="color: #4c83ff;">&lt;-</span> sppred(SAR, condset= <span style="color: #61CE3C;">"XW"</span>)
SARprdXWi <span style="color: #4c83ff;">&lt;-</span> sppred(SAR, condset= <span style="color: #61CE3C;">"XW"</span>, avg= <span style="color: #61CE3C;">"INV"</span>)
SDMprdXW <span style="color: #4c83ff;">&lt;-</span> sppred(SDM, condset= <span style="color: #61CE3C;">"XW"</span>)
SDMprdXWi <span style="color: #4c83ff;">&lt;-</span> sppred(SDM, condset= <span style="color: #61CE3C;">"XW"</span>, avg= <span style="color: #61CE3C;">"INV"</span>)
SEMprdXW <span style="color: #4c83ff;">&lt;-</span> sppred(SEM, condset= <span style="color: #61CE3C;">"XW"</span>, avg= <span style="color: #61CE3C;">"INV"</span>)
SEMprdXW <span style="color: #4c83ff;">&lt;-</span> sppred(SEM, condset= <span style="color: #61CE3C;">"XW"</span>,
                   newdata= exsmp$Dat.cal, listw= exsmp$Wgt.cal)
SXMprdXW <span style="color: #4c83ff;">&lt;-</span> sppred(SXM, condset= <span style="color: #61CE3C;">"XW"</span>,
                   newdata= exsmp$Dat.cal, listw= exsmp$Wgt.cal)
summary(SEMprdX)
summary(SEMprdXW)
SXMprdX <span style="color: #4c83ff;">&lt;-</span> sppred(SXM, condset= <span style="color: #61CE3C;">"XW"</span>)
SXMprdXW <span style="color: #4c83ff;">&lt;-</span> sppred(SXM, newdata= exsmp$Dat.cal,
                   condset= <span style="color: #61CE3C;">"XW"</span>, listw= exsmp$Wgt.cal)
SARprdX <span style="color: #4c83ff;">&lt;-</span> sppred(SAR, condset= <span style="color: #61CE3C;">"X"</span>)
SARprdXW <span style="color: #4c83ff;">&lt;-</span> sppred(SAR, condset= <span style="color: #61CE3C;">"XW"</span>)
sqrt(mean(I(SEMprdX- SAR$y)^2))
sqrt(mean(I(SXMprdX- SAR$y)^2))
sqrt(mean(I(SARprdX- SAR$y)^2))
sqrt(mean(I(SARprdXW- SAR$y)^2))
sqrt(mean(I(SDMprdXWi- SAR$y)^2))
sqrt(mean(I(SACprdX- SAR$y)^2))
sqrt(mean(I(SMCprdX- SAR$y)^2))
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">

<div class="footdef"><sup><a id="fn.1" name="fn.1" class="footnum" href="#fnr.1">1</a></sup> <p class="footpara">
This model has different names in the literature: spatial
autoregressive model with autoregressive disturbances (SARAR(1,1),
Kelejian and Prucha, 1998) or Spatial Autoregressive Conditional (SAC,
XX). We retain XX here.
</p></div>


</div>
</div></div>
</body>
</html>
